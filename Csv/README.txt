< 새로 생기는 파일 및 경로 >
1. 파일명: stock_csv_service.py
경로: app/services/stock_csv_service.py (현재 진행중인 프로젝트의 트리에 맞춤)

2. 파일명: stock_csv_router.py
경로: app/routers/stock_csv_router.py

-------------------------------------------------------------------------------------------------------------------

< 환경설정 >
1. 인코딩 기본값: 입력은 utf-8-sig(엑셀 BOM 포함 케이스 안전), 출력은 utf-8
※ 현재 환경에선 UTF-8 with BOM 이슈가 발생할 우려있으니, utf-8-sig로 강제해서 혼선 방지.

2. 의존성: python-multipart (파일 업로드에 필수)
requirements.txt에 없으면 추가 → pip install python-multipart

3. 서버 응답 유틸: from fastapi import UploadFile, File, from starlette.responses import StreamingResponse

-------------------------------------------------------------------------------------------------------------------

< 데이터 정책 >
StockCSVRow.expected_headers() 기준
- 헤더 표준: ["sku","name","category_id","quantity","price","location","min_stock","target_stock","note"]
- 필수 컬럼: sku, name, category_id, quantity

- category_id 유효성: FK 존재 확인(없으면 실패 행으로 분류)

- 데이터 중복 처리(중요): 예시) CSV에 같은 sku가 여러 번 나오면?
a) 첫 행만 반영, 나머지 실패
b) 마지막 행 우선(덮어쓰기)	→ 채택.

- sku 기준으로 있으면 업데이트, 없으면 생성

- (트랜잭션 정책)
a) 부분 성공 허용(성공/실패 분리, 기본)
b) 한 행 실패 시 전체 롤백(거래 규정상 필요할 때만)

- 감사 로그: 임포트 수행자·성공/실패 카운트 저장

- (변수 검증 규칙)
1. sku, name 비어 있으면 실패
2. category_id ≥ 1, quantity ≥ 0, price ≥ 0

-------------------------------------------------------------------------------------------------------------------

- 드라이런 옵션: ?dry_run=true 지원하면 운영자 호평(실제 반영 없이 실패행만 미리 확인)

드라이런이란?: 실적용은 안 하고, 적용했을 때 무슨 일이 벌어질지 그대로 보여주는 시뮬레이션

사용 예시: CSV 임포트에서 ?dry_run=true로 호출하면
파일을 끝까지 검증하고,
실제로는 DB에 쓰지 않고,
“몇 건이 생성/수정될 예정인지, 어떤 행이 왜 실패하는지”만 리포트로 보내줌.

드라이런 기대 효과
1. 사고 예방: 잘못된 CSV 데이터로 원본의 실제 데이터를 망가뜨리기 전에 미리 잡을 수 있음
(예상 오류: 카테고리 FK 잘못, 음수 수량, 중복 SKU 등)
2. 확신 확보: 사용법에 대한 확신 + 실제로 올리면 어떻게 변하는 지 안전하게 체감 가능
3. 반복 테스트 가능: 파일 수정 후 드라이런 여러 번 돌려도 부작용 없음 (현 데이터 그대로 유지)
4. 협업에 유리: 개발자에게 직접 초기 오류를 보내줄 수 있음 (만드는 것에 그치지 않고 유지보수에 유리함)
5. 검사/승인 프로세스: 드라이런 결과 캡처해서 결재 받고, 승인 후 실제 실행. + 문제 발생 시 원인 추적 쉬움. 
(결재 과정은 프로젝트의 방향성에 맞지 않을 경우(예시: 결재과정을 생략한 모델), 내용 삭제하기)

특히 어떤 경우에 유용한가?
- 신규 마스터 대량 등록(초도 적재)
- 배치 전 사전 점검
- 포맷 바뀐 외부 공급사 CSV 반영 전
- 실수 한 번이면 큰일 나는 가격/수량 일괄 수정 작업


-------------------------------------------------------------------------------------------------------------------

< UX·API 설계(라벨 확정) >

- 업로드: POST /stocks/import
form field 이름: file (UploadFile)
쿼리: dry_run(bool), dedup("first"|"last") 등 선택
응답: ImportReport(성공/실패 카운트 + 실패목록)

- 다운로드: GET /stocks/export
쿼리: category_id, min_quantity, query, order_by, order_dir
응답: text/csv 스트리밍, 헤더는 StockCSVRow.expected_headers()

- 템플릿 버튼: templates/stock.html에 “CSV 업로드” / “CSV 다운로드” 버튼 2개(나중 단계)

-------------------------------------------------------------------------------------------------------------------

< 엑셀/윈도우 특이점 >
- 엑셀은 저장 시 기본이 CSV UTF-8(BOM 포함) → 입력을 utf-8-sig로 읽으면 OK
(현재 환경에서는 BOM을 제외시키기로 정했으므로 utf-8-sig)

- 셀에 쉼표(,)가 있으면 엑셀이 자동으로 따옴표로 감쌈 → 표준 csv 모듈 사용 시 자동 처리

- 줄바꿈/따옴표가 섞인 설명 필드가 있어도 csv 모듈이 안전하게 파싱

- 소수점/천단위 구분자: 엑셀 지역설정에 따라 달라질 수 있으나,
CSV 수치는 원문 그대로 들어오므로 문자열→수치 변환만 확실히(이미 pydantic 검증으로 커버)

-------------------------------------------------------------------------------------------------------------------

< 수락 기준(Accept Criteria) >

- 업로드 시 성공/실패 카운트와 실패행 사유가 응답에 명확히 나온다.
- dry_run=true로 호출하면 DB 변경 없이 리포트만 나온다.
- 익스포트는 필터 쿼리 적용 후 CSV 스트리밍으로 다운로드된다.
- 엑셀에서 저장한 CSV(UTF-8 with BOM)도 오류 없이 임포트된다.